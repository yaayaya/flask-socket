<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project1</title>
    <script type=text/javascript src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script type=text/javascript src="{{ url_for('static', filename='js/vue-dev.js') }}"></script>
    <script type=text/javascript src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
</head>

<body>
    <div id="vueApp">
        <img id="ccaImg" :style="styleObj" src="{{ url_for('static', filename='img/3080.jpg') }}">
    </div>
</body>

</html>

<script>
    // 創建Socket
    var socket = io();
    startTime = 0
    DataDelayTime = 0
    var targetElm = document.querySelector('#ccaImg')

    let vm = new Vue({
        el: "#vueApp",
        data: {
            blurValue: [0, 0],
            startTime: [(new Date).getTime(), 0],
            DataDelayTime: [0, 0],
            isLoading: false,
            currenBlurValue : 0,

            styleObj:{
                filter: 'blur(0px)'
            }
        },
        methods: {
            getValue() {
                // 可取得資料時 發送
                if (!this.isLoading) {
                    this.isLoading = true
                    socket.emit('getValue');
                }
            },
            setBlur(){
                setInterval(() => {
                    let _blurDiff = (this.blurValue[0] - this.blurValue[1])
                    console.log(_blurDiff)
                    if (_blurDiff > 0){
                        if (this.currenBlurValue <= this.blurValue[0]){
                            this.currenBlurValue += (_blurDiff/10)
                        }
                    }
                    else{
                        if (this.currenBlurValue >= this.blurValue[0]){
                            this.currenBlurValue += (_blurDiff/10)
                        }
                    }
                    console.log(vm.currenBlurValue)
                    this.styleObj.filter = `blur(${vm.currenBlurValue}px)`
                }, 50);
            }
        },
        mounted() {

            // 每500毫秒檢查一次是否已可去取得資料
            setInterval(() => {
                this.getValue()
            }, 500);

            // 連線成功時執行  呼叫後端getValue方法
            socket.on('connect', function () {
                socket.emit('getValue');
            });

            // 接收到後端請求，取得資料後設定新圖片
            socket.on('setValue', (e) => {
                e.data = e.data / 10
                // 資料與資料接收間隔時間
                // 更新資料延遲時間舊[1]
                // 放置於新 資料延遲時間[0]
                this.DataDelayTime[1] = this.DataDelayTime[0]
                this.startTime[1] = this.startTime[0]
                this.startTime[0] = (new Date).getTime()
                this.DataDelayTime[0] = (new Date).getTime() - this.startTime[1]

                // 資料
                this.blurValue[1] = this.blurValue[0]
                this.blurValue[0] = e.data

                // 當前模糊值
                this.currenBlurValue = this.blurValue[1]

                this.isLoading = false
            });

            // 設定模糊
            this.setBlur()
        }
    })
</script>